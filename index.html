<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Liga de Softbol PEGA - MLB Style</title>
    
    <!-- 1. Estilos y Fuentes -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Black+Ops+One&family=Roboto:wght@400;500;700;900&family=Teko:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- 2. Librer√≠as Externas -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- ========================================== -->
    <!--     3. CONFIGURACI√ìN DE FIREBASE           -->
    <!-- ========================================== -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // TUS LLAVES REALES
        const firebaseConfig = {
            apiKey: "AIzaSyBiyx9qNhBgXknIsM3kmanksNsOKi4p090",
            authDomain: "liga-softbol-pega.firebaseapp.com",
            projectId: "liga-softbol-pega",
            storageBucket: "liga-softbol-pega.firebasestorage.app",
            messagingSenderId: "123479362384",
            appId: "1:123479362384:web:90521fca4eb4c5fa3e3a55",
            measurementId: "G-WKK22W19CT"
        };

        // Inicializaci√≥n Segura
        try {
            const app = initializeApp(firebaseConfig);
            window.db = getFirestore(app);
            window.storage = getStorage(app);
            window.auth = getAuth(app);
            
            signInAnonymously(window.auth)
                .then(() => console.log("üî• Firebase: Conectado (An√≥nimo)"))
                .catch(err => console.warn("‚ö†Ô∏è Firebase Auth:", err.message));

        } catch (e) {
            console.error("‚ùå Error inicializando Firebase:", e);
        }

        // Funci√≥n de subida global
        window.handleUpload = async function(event) {
            event.preventDefault();
            const SHARED_PASSWORD = "SOFTBOL2025";
            
            if (!window.storage) {
                showToast("Error: Base de datos no conectada.", "error");
                return;
            }

            const teamSelect = document.getElementById('teamSelect');
            const fileInput = document.getElementById('logoFile');
            const passwordInput = document.getElementById('teamPassword');
            const submitBtn = document.querySelector('#uploadForm button[type="submit"]');

            if (!teamSelect.value || !fileInput.files[0]) {
                showToast("Faltan datos: Elige equipo y logo.", "warning");
                return;
            }
            if (passwordInput.value.trim().toUpperCase() !== SHARED_PASSWORD) {
                showToast("Contrase√±a incorrecta.", "error");
                return;
            }

            const file = fileInput.files[0];
            if (file.size > 15 * 1024 * 1024) {
                showToast("Imagen muy pesada (M√°x 15MB).", "warning");
                return;
            }

            const originalBtnText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> Subiendo...`;
            lucide.createIcons();

            try {
                const fileName = `logos/${teamSelect.value.replace(/[^a-z0-9]/gi, '_')}_${Date.now()}`;
                const storageRef = ref(window.storage, fileName);
                
                const snapshot = await uploadBytes(storageRef, file);
                const downloadURL = await getDownloadURL(snapshot.ref);

                await addDoc(collection(window.db, "pending_logos"), {
                    team: teamSelect.value,
                    logoUrl: downloadURL,
                    status: "pending",
                    createdAt: serverTimestamp()
                });

                showToast("¬°Logo enviado con √©xito!", "success");
                document.getElementById('uploadModal').close();
                document.getElementById('uploadForm').reset();
            } catch (error) {
                console.error("Upload Error:", error);
                showToast("Error al subir: " + error.message, "error");
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnText;
                lucide.createIcons();
            }
        }
    </script>

    <!-- 4. Estilos Personalizados -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        pega: { navy: '#0f172a', blue: '#1e3a8a', gold: '#fbbf24', red: '#dc2626' }
                    },
                    fontFamily: {
                        'logo': ['"Black Ops One"', 'cursive'],
                        'sport': ['"Teko"', 'sans-serif'],
                        'body': ['"Roboto"', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        body { 
            font-family: 'Roboto', sans-serif; 
            background-color: #0f172a;
            background-image: linear-gradient(to bottom, rgba(15, 23, 42, 0.85), rgba(15, 23, 42, 0.95)), 
                              url('https://images.unsplash.com/photo-1595030044556-ac55b18ca988?q=80&w=2069&auto=format&fit=crop');
            background-size: cover;
            background-attachment: fixed;
            background-position: center;
            color: white;
        }

        .mlb-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }
        .gold-gradient { background: linear-gradient(135deg, #fbbf24 0%, #d97706 100%); }
        .silver-gradient { background: linear-gradient(135deg, #e2e8f0 0%, #94a3b8 100%); }
        .bronze-gradient { background: linear-gradient(135deg, #fdba74 0%, #c2410c 100%); }

        .custom-scrollbar::-webkit-scrollbar { height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #fbbf24; border-radius: 3px; }

        .fade-in { animation: fadeIn 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .tab-active { background: #fbbf24; color: #0f172a; border-bottom: 4px solid #b45309; box-shadow: 0 0 15px rgba(251, 191, 36, 0.4); }
        .tab-inactive { background: rgba(255,255,255,0.05); color: #94a3b8; border: 1px solid rgba(255,255,255,0.1); }
        .tab-inactive:hover { background: rgba(255,255,255,0.1); color: white; }

        dialog::backdrop { background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(8px); }
        
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
        .toast { padding: 12px 20px; border-radius: 8px; color: white; font-weight: 500; box-shadow: 0 4px 10px rgba(0,0,0,0.5); animation: slideIn 0.3s ease-out; min-width: 250px; display: flex; align-items: center; gap: 10px; background: #333; border-left: 4px solid #888; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .toast-success { background: #064e3b; border-color: #34d399; }
        .toast-error { background: #7f1d1d; border-color: #f87171; }
        .toast-warning { background: #78350f; border-color: #facc15; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <!-- Navbar -->
    <nav class="bg-pega-navy/90 backdrop-blur-md border-b border-white/10 sticky top-0 z-50 shadow-2xl">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between h-20 items-center">
                <!-- Logo con acci√≥n de volver al inicio -->
                <div class="flex items-center gap-4 group cursor-pointer" onclick="goHome()">
                    <div class="relative">
                        <div class="absolute inset-0 bg-pega-gold rounded-full blur opacity-40 group-hover:opacity-60 transition duration-500"></div>
                        <div class="relative bg-white p-2 rounded-full border-2 border-pega-gold transform group-hover:scale-110 transition duration-300">
                            <i data-lucide="baseball" class="w-8 h-8 text-pega-blue fill-current"></i>
                        </div>
                    </div>
                    <div class="flex flex-col">
                        <span class="font-logo text-3xl tracking-wider text-white leading-none drop-shadow-md">LIGA PEGA</span>
                        <span class="text-[10px] text-pega-gold tracking-[0.3em] uppercase font-bold">Official Stats</span>
                    </div>
                </div>
                
                <!-- Bot√≥n Volver / Refresh -->
                <div class="flex gap-2">
                    <button id="back-btn" onclick="goHome()" class="hidden p-2 bg-white/10 rounded-full hover:bg-white/20 transition text-white">
                        <i data-lucide="home" class="w-6 h-6"></i>
                    </button>
                    <button onclick="loadCurrentTab()" class="p-2 hover:bg-white/10 rounded-full transition text-pega-gold hover:text-white hover:rotate-180 duration-700">
                        <i data-lucide="refresh-cw" class="w-6 h-6"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Hero -->
    <div class="relative pt-10 pb-6 overflow-hidden">
        <div class="max-w-7xl mx-auto px-4 relative z-10 text-center">
            <div class="inline-flex items-center justify-center gap-3 mb-6 animate-pulse">
                <div class="h-px w-12 bg-gradient-to-r from-transparent to-pega-gold"></div>
                <span class="text-pega-gold text-xs font-bold tracking-[0.2em] uppercase">11 VA TEMPORADA</span>
                <div class="h-px w-12 bg-gradient-to-l from-transparent to-pega-gold"></div>
            </div>
            <h1 class="text-4xl md:text-6xl font-sport font-bold uppercase tracking-wide text-white drop-shadow-[0_4px_4px_rgba(0,0,0,0.8)] mb-2 leading-none">
                LIGA DE SOFBOL<br><span class="text-transparent bg-clip-text bg-gradient-to-b from-white to-slate-400">ROMEROS LEAGUE</span>
            </h1>
            <p class="text-sm md:text-base text-pega-gold/90 font-bold tracking-widest uppercase mb-8 opacity-80">(¬°ANIMO MI REY!)</p>

            <!-- MEN√ö PRINCIPAL (HOME) -->
            <div id="home-menu" class="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-4xl mx-auto mt-8 fade-in relative z-30">
                <!-- Bot√≥n Standings -->
                <button onclick="enterSection('standing')" class="mlb-card group relative p-8 rounded-2xl text-left hover:border-pega-gold/50 transition-all duration-300 transform hover:-translate-y-1 hover:shadow-2xl hover:shadow-pega-gold/20 cursor-pointer">
                    <div class="absolute inset-0 bg-gradient-to-br from-pega-blue/20 to-transparent opacity-0 group-hover:opacity-100 transition duration-500"></div>
                    <div class="relative z-10 flex items-center justify-between">
                        <div>
                            <h2 class="text-4xl font-sport text-white mb-2 group-hover:text-pega-gold transition">STANDINGS</h2>
                            <p class="text-slate-400 text-sm">Tablas generales por grupo</p>
                        </div>
                        <i data-lucide="list" class="w-12 h-12 text-white/20 group-hover:text-pega-gold group-hover:scale-110 transition duration-500"></i>
                    </div>
                </button>
                <!-- Bot√≥n L√≠deres -->
                <button onclick="enterSection('leader')" class="mlb-card group relative p-8 rounded-2xl text-left hover:border-pega-gold/50 transition-all duration-300 transform hover:-translate-y-1 hover:shadow-2xl hover:shadow-pega-gold/20 cursor-pointer">
                    <div class="absolute inset-0 bg-gradient-to-br from-pega-red/20 to-transparent opacity-0 group-hover:opacity-100 transition duration-500"></div>
                    <div class="relative z-10 flex items-center justify-between">
                        <div>
                            <h2 class="text-4xl font-sport text-white mb-2 group-hover:text-pega-gold transition">L√çDERES</h2>
                            <p class="text-slate-400 text-sm">AVG, HR, JG y estad√≠sticas</p>
                        </div>
                        <i data-lucide="trophy" class="w-12 h-12 text-white/20 group-hover:text-pega-gold group-hover:scale-110 transition duration-500"></i>
                    </div>
                </button>
            </div>

            <!-- NAVEGACI√ìN SECUNDARIA (PESTA√ëAS) -->
            <div id="tabs-navigation" class="hidden fade-in relative z-30">
                <div class="flex flex-wrap justify-center gap-3" id="tabs-container"></div>
            </div>
        </div>
    </div>

    <!-- Main -->
    <main class="flex-grow max-w-7xl mx-auto px-4 w-full relative z-20 pb-12">
        
        <div id="loader" class="mlb-card p-12 rounded-2xl text-center mx-auto max-w-md hidden mt-8">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-pega-gold mx-auto mb-6"></div>
            <p class="text-white font-sport text-2xl tracking-wide animate-pulse">CARGANDO DATOS...</p>
        </div>
        
        <!-- SECCI√ìN RESULTADOS RECIENTES (J2:O100) - Solo visible en Super A- -->
        <div id="recent-results" class="hidden fade-in mb-8">
            <div class="flex items-center justify-between mb-4 px-2">
                <h3 class="font-sport text-2xl text-pega-gold uppercase flex items-center gap-2">
                    <i data-lucide="calendar-days" class="w-6 h-6"></i> Resultados Recientes
                </h3>
            </div>
            <!-- Contenedor con Scroll Horizontal -->
            <div id="results-scroller" class="flex gap-4 overflow-x-auto custom-scrollbar pb-4">
                <!-- Se inyectan con JS -->
            </div>
        </div>

        <div id="data-container" class="hidden fade-in space-y-8 mt-4"></div>

        <!-- BOT√ìN DE AN√ÅLISIS ESTAD√çSTICO (SIN IA EXTERNA) -->
        <div id="analysis-wrapper" class="hidden mt-8 max-w-5xl mx-auto fade-in">
            <button onclick="generateStaticAnalysis()" id="btn-analyze" class="w-full bg-gradient-to-r from-pega-blue to-pega-navy hover:from-blue-600 hover:to-blue-800 text-white font-black py-4 rounded-xl shadow-lg transform transition hover:scale-105 flex items-center justify-center gap-3 text-xl border border-white/20 group cursor-pointer z-30 relative">
                <i data-lucide="bar-chart-3" class="w-6 h-6 text-pega-gold group-hover:animate-pulse"></i>
                ANALIZAR EQUIPO POR EQUIPO
            </button>
            
            <div id="analysis-result" class="hidden mt-6 bg-[#0f172a]/95 border border-pega-gold/30 rounded-xl p-6 shadow-2xl relative overflow-hidden backdrop-blur-xl">
                <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-pega-gold to-transparent opacity-50"></div>
                <div class="flex items-center gap-3 mb-6 pb-4 border-b border-white/10">
                    <div class="bg-pega-gold/20 p-2 rounded-lg">
                        <i data-lucide="clipboard-list" class="w-6 h-6 text-pega-gold"></i>
                    </div>
                    <h3 class="font-sport text-2xl text-white tracking-wide">REPORTE DE SCOUTING</h3>
                </div>
                <div id="analysis-content" class="text-slate-300 space-y-4"></div>
            </div>
        </div>

    </main>

    <!-- Modal Upload -->
    <dialog id="uploadModal" class="rounded-2xl shadow-2xl p-0 w-full max-w-md bg-[#0f172a] border border-white/10 text-white backdrop:bg-black/90 z-50">
        <div class="bg-gradient-to-r from-pega-navy to-pega-blue p-5 flex justify-between items-center border-b border-white/10">
            <h3 class="font-sport text-2xl flex items-center gap-2 tracking-wide text-white"><i data-lucide="shield" class="w-6 h-6 text-pega-gold"></i> ZONA CAPITANES</h3>
            <button onclick="document.getElementById('uploadModal').close()" class="text-slate-400 hover:text-white transition"><i data-lucide="x" class="w-6 h-6"></i></button>
        </div>
        <div class="p-8">
            <form id="uploadForm" class="space-y-5" onsubmit="handleUpload(event)">
                <div><label class="block text-xs font-bold text-pega-gold uppercase mb-2">Equipo</label><select id="teamSelect" class="w-full bg-black/40 border border-white/20 rounded-lg p-3 text-white"><option value="">Seleccionar...</option></select></div>
                <div><label class="block text-xs font-bold text-pega-gold uppercase mb-2">C√≥digo</label><input type="password" id="teamPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="w-full bg-black/40 border border-white/20 rounded-lg p-3 text-white"></div>
                <div><label class="block text-xs font-bold text-pega-gold uppercase mb-2">Logo</label><input id="logoFile" type="file" class="w-full bg-black/40 border border-white/20 rounded-lg p-3 text-white" accept="image/*" /></div>
                <button type="submit" class="w-full bg-pega-gold hover:bg-yellow-400 text-pega-navy font-black rounded-lg p-4">Enviar Logo</button>
            </form>
        </div>
    </dialog>

    <footer class="bg-black/50 backdrop-blur-sm text-slate-500 py-8 border-t border-white/5 mt-auto relative z-20">
        <div class="max-w-7xl mx-auto px-4 flex justify-between items-center">
            <span class="text-xs font-medium tracking-wider">¬© 2025 LIGA SOFTBOL PEGA</span>
            <button onclick="openUploadModal()" class="text-[10px] uppercase font-bold tracking-widest bg-white/5 px-4 py-2 rounded-full hover:bg-pega-gold hover:text-pega-navy transition border border-white/10">Acceso Capitanes</button>
        </div>
    </footer>

    <!-- 5. Script Principal -->
    <script>
        const BASE_SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRGTo3bXEvL_J54VjF26ilMUnTDPLXo0wkDTqdJ86I75WfDUyCu4lfeMupwOqL3KnJsAz4QPAy7oBw0/pub";
        const RESULTS_SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTbbwfGXERgrw9oT76NSLFEnGrFixNZlFzzaznj7nl_hjC370RNL6_GL-EidxKtLTr3VZSqOn_ydOJX/pub?gid=273219991&single=true&output=csv";
        
        const TABS = [
            { id: 'super-a', name: 'SUPER A-', gid: '230992862', type: 'standing', maxRows: 12 }, 
            { id: 'grupo-a', name: 'GRUPO A-', gid: '536702171', type: 'standing', maxRows: 12 },
            { id: 'grupo-a-plus', name: 'GRUPO A+', gid: '1046265940', type: 'standing', maxRows: 12 },
            { id: 'grupo-a-4plus', name: 'GRUPO A++++', gid: '15007088', type: 'standing', maxRows: 12 },
            { id: 'grupo-b', name: 'GRUPO B', gid: '806756321', type: 'standing', maxRows: 12 },
            { id: 'grupo-c', name: 'GRUPO C', gid: '575223888', type: 'standing', maxRows: 12 },
            { id: 'grupo-fds-a', name: 'FDS A', gid: '2031015446', type: 'standing', maxRows: 12 },
            { id: 'grupo-fds-b', name: 'FDS B', gid: '803338116', type: 'standing', maxRows: 12 },
            { id: 'grupo-fds-c', name: 'FDS C', gid: '1068943726', type: 'standing', maxRows: 12 },
            { id: 'leader-avg', name: 'AVG', gid: '0', type: 'leader', colStart: 0, nameCol: 0, teamCol: 1, statCol: 2, groupCol: 3, icon: 'crosshair', color: 'from-blue-600 to-blue-800', label: 'AVG' },
            { id: 'leader-hr', name: 'HR', gid: '0', type: 'leader', colStart: 4, nameCol: 4, teamCol: 5, statCol: 6, groupCol: 7, icon: 'zap', color: 'from-red-600 to-red-800', label: 'HR' },
            { id: 'leader-jg', name: 'JG', gid: '0', type: 'leader', colStart: 8, nameCol: 8, teamCol: 9, statCol: 10, groupCol: 11, icon: 'trophy', color: 'from-yellow-500 to-yellow-700', label: 'JG' }
        ];

        const DISPLAY_ORDER_PRIORITY = [ "SUPER A-", "GRUPO SUPER A-", "A-", "GRUPO A-", "A+", "GRUPO A+", "A++++", "A+++", "GRUPO A++++", "GRUPO A+++", "B", "GRUPO B", "C", "GRUPO C", "FDS A", "GRUPO FDS A", "FDS B", "GRUPO FDS B", "FDS C", "GRUPO FDS C" ];

        let currentTabId = null;
        let globalData = [];
        let loadedTeams = [];
        let teamLeadersInfo = {}; 

        // Funci√≥n segura para actualizar iconos
        function refreshIcons() {
            if (typeof lucide !== 'undefined' && lucide.createIcons) {
                lucide.createIcons();
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            refreshIcons();
            goHome();
            preloadLeaders(); 
        });

        // --- NAVEGACI√ìN ---
        function goHome() {
            document.getElementById('home-menu').classList.remove('hidden');
            document.getElementById('tabs-navigation').classList.add('hidden');
            document.getElementById('data-container').classList.add('hidden');
            document.getElementById('analysis-wrapper').classList.add('hidden');
            document.getElementById('recent-results').classList.add('hidden'); 
            document.getElementById('back-btn').classList.add('hidden');
            currentTabId = null;
        }

        function enterSection(type) {
            document.getElementById('home-menu').classList.add('hidden');
            document.getElementById('tabs-navigation').classList.remove('hidden');
            document.getElementById('data-container').classList.remove('hidden');
            document.getElementById('back-btn').classList.remove('hidden');
            
            // Mostrar bot√≥n An√°lisis solo en Standings
            if (type === 'standing') {
                document.getElementById('analysis-wrapper').classList.remove('hidden');
            } else {
                document.getElementById('analysis-wrapper').classList.add('hidden');
            }

            renderTabs(type);
            const firstTab = TABS.find(t => t.type === type);
            if (firstTab) switchTab(firstTab.id);
        }

        function renderTabs(filterType) {
            const container = document.getElementById('tabs-container');
            const filteredTabs = TABS.filter(t => t.type === filterType);
            
            container.innerHTML = filteredTabs.map(tab => {
                const isLeader = tab.type === 'leader';
                return `
                <button onclick="switchTab('${tab.id}')" class="px-5 py-2.5 rounded-lg font-bold text-sm tracking-wide transition-all transform hover:-translate-y-1 hover:shadow-lg ${currentTabId === tab.id ? 'tab-active' : 'tab-inactive'} ${isLeader ? 'border-pega-gold/50' : ''}">
                    ${isLeader ? `<span class="flex items-center gap-1"><i data-lucide="${tab.icon}" class="w-3 h-3"></i> ${tab.name}</span>` : tab.name}
                </button>
            `}).join('');
            refreshIcons();
        }

        function switchTab(id) {
            currentTabId = id;
            const activeTab = TABS.find(t => t.id === id);
            renderTabs(activeTab.type);
            loadCurrentTab();
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            let icon = type === 'success' ? 'check-circle' : (type === 'error' ? 'alert-circle' : 'info');
            toast.innerHTML = `<i data-lucide="${icon}" class="w-5 h-5"></i> <span>${message}</span>`;
            container.appendChild(toast);
            refreshIcons();
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }

        async function fetchWithProxy(url) {
            try {
                const proxy1 = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
                const res = await fetch(proxy1);
                if (res.ok) return await res.text();
            } catch (e) { console.warn("Proxy 1 fall√≥", e); }

            try {
                const proxy2 = `https://corsproxy.io/?${encodeURIComponent(url)}`;
                const res = await fetch(proxy2);
                if (res.ok) return await res.text();
            } catch (e) { console.warn("Proxy 2 fall√≥", e); }

            const res = await fetch(url);
            if (!res.ok) throw new Error("Fallo total de conexi√≥n");
            return await res.text();
        }

        async function loadCurrentTab() {
            const container = document.getElementById('data-container');
            const loader = document.getElementById('loader');
            const activeTab = TABS.find(t => t.id === currentTabId);

            container.innerHTML = '';
            loader.style.display = 'block';
            document.getElementById('analysis-result').classList.add('hidden'); 

            const recentResultsContainer = document.getElementById('recent-results');
            if (activeTab.id === 'super-a') {
                recentResultsContainer.classList.remove('hidden');
                loadRecentResults(); 
            } else {
                recentResultsContainer.classList.add('hidden');
            }

            const csvUrl = `${BASE_SHEET_URL}?gid=${activeTab.gid}&single=true&output=csv`;

            try {
                let text = await fetchWithProxy(csvUrl);
                let rows = parseCSV(text);
                
                if (activeTab.type === 'leader') {
                    let slicedRows = rows.slice(0, 45); 
                    let groupedData = processLeaderData(slicedRows, activeTab);
                    renderGroupedLeaderBoard(groupedData, activeTab);
                } else {
                    if (activeTab.maxRows) rows = rows.slice(0, activeTab.maxRows);
                    
                    // --- FILTRO MEJORADO DE FILAS VAC√çAS ---
                    const cleanRows = rows.filter(r => {
                        const teamName = r[1] ? r[1].trim() : "";
                        const pos = r[0] ? r[0].trim() : "";
                        
                        return r.length > 1 && 
                               pos !== "" && 
                               !pos.toUpperCase().includes("POS") && 
                               !teamName.toUpperCase().includes("EQUIPO") &&
                               teamName !== "-" && 
                               teamName !== ""; 
                    });

                    globalData = cleanRows;
                    renderStandings(cleanRows);
                    loadedTeams = cleanRows.map(r => r[1]); 
                    updateUploadOptions();
                }

            } catch (error) {
                console.error(error);
                showToast("Error cargando datos. Revisa tu internet.", "error");
                container.innerHTML = `<div class="bg-red-900/50 border border-red-500 text-white p-6 rounded-xl text-center"><i data-lucide="alert-triangle" class="w-8 h-8 mx-auto mb-2 text-red-400"></i><p>No se pudo conectar con la Hoja de Datos.</p></div>`;
                refreshIcons();
            } finally {
                loader.style.display = 'none';
                refreshIcons();
            }
        }

        async function loadRecentResults() {
            const scroller = document.getElementById('results-scroller');
            scroller.innerHTML = `<div class="text-white text-xs p-4">Cargando resultados...</div>`;

            try {
                let text = await fetchWithProxy(RESULTS_SHEET_URL);
                let rows = parseCSV(text);
                const validMatches = rows.filter(r => r[9] && r[9].trim() !== "");
                const last5 = validMatches.slice(-5).reverse(); 

                let html = '';
                last5.forEach(match => {
                    const teamA = match[9];
                    const scoreA = match[10];
                    const scoreB = match[11];
                    const teamB = match[12];

                    html += `
                        <div class="mlb-card bg-[#0f172a]/90 p-5 rounded-xl min-w-[220px] border border-white/10 flex flex-col items-center justify-center shadow-lg transform hover:-translate-y-1 transition duration-300 group">
                            <div class="w-full text-center space-y-3">
                                <div class="font-black text-white text-lg uppercase truncate tracking-wide" title="${teamA}">${teamA}</div>
                                <div class="bg-black/60 rounded-lg py-2 px-6 border border-[#fbbf24]/40 inline-block shadow-[0_0_15px_rgba(251,191,36,0.1)] group-hover:shadow-[0_0_20px_rgba(251,191,36,0.3)] transition">
                                    <span class="font-[Teko] text-4xl text-[#fbbf24] tracking-widest leading-none drop-shadow-md">${scoreA}-${scoreB}</span>
                                </div>
                                <div class="font-black text-white text-lg uppercase truncate tracking-wide" title="${teamB}">${teamB}</div>
                            </div>
                        </div>
                    `;
                });
                if (last5.length === 0) { scroller.innerHTML = `<div class="text-slate-500 text-xs italic p-2">Sin resultados recientes.</div>`; } 
                else { scroller.innerHTML = html; }
            } catch (e) {
                console.error("Error loading results", e);
                scroller.innerHTML = `<div class="text-red-400 text-xs p-2">Error resultados.</div>`;
            }
        }

        function updateUploadOptions() {
            const uploadSelect = document.getElementById('teamSelect');
            if (loadedTeams.length > 0) {
                uploadSelect.innerHTML = '<option value="">Selecciona...</option>' + loadedTeams.map(t => `<option value="${t}">${t}</option>`).join('');
            }
        }

        function parseCSV(text) { return text.split('\n').map(l => l.split(',').map(c => c.trim().replace(/^"|"$/g, ''))); }

        async function preloadLeaders() {
            console.log("Cargando l√≠deres en segundo plano...");
            const csvUrl = `${BASE_SHEET_URL}?gid=0&single=true&output=csv`;
            try {
                let text = await fetchWithProxy(csvUrl);
                const rows = parseCSV(text).slice(0, 45); 
                const leaderConfigs = TABS.filter(t => t.type === 'leader');
                leaderConfigs.forEach(config => {
                    const data = processLeaderData(rows, config);
                    for (let group in data) {
                        const leaders = data[group];
                        if (leaders.length > 0) {
                            const topLeader = leaders[0]; 
                            const teamName = topLeader.team.toUpperCase().trim();
                            if (!teamLeadersInfo[teamName]) teamLeadersInfo[teamName] = [];
                            teamLeadersInfo[teamName].push(`${config.label}: ${topLeader.name} (${topLeader.stat})`);
                        }
                    }
                });
            } catch (e) { console.warn("Preload l√≠deres fall√≥", e); }
        }

        function processLeaderData(rows, config) {
            let groups = {};
            let currentGroupName = "GENERAL";
            rows.forEach((r, index) => {
                if (r[config.colStart] && isNaN(r[config.colStart]) && r[config.colStart].length > 3) { }
                let groupIndex = Math.floor(index / 5);
                const fallbackNames = ["SUPER A-", "GRUPO A-", "GRUPO A+", "GRUPO A++++", "GRUPO B", "GRUPO C", "FDS A", "FDS B", "FDS C"];
                if (groupIndex < fallbackNames.length) currentGroupName = fallbackNames[groupIndex];
                if (r[config.groupCol] && r[config.groupCol].trim() !== "") currentGroupName = r[config.groupCol].trim().toUpperCase();

                let player = { rank: 0, name: r[config.nameCol] || '', team: r[config.teamCol] || '', stat: r[config.statCol] || '0' };
                if (player.name && player.name !== "" && player.stat !== '0') {
                    if (!groups[currentGroupName]) groups[currentGroupName] = [];
                    groups[currentGroupName].push(player);
                }
            });
            for (let g in groups) groups[g].sort((a, b) => parseFloat(b.stat) - parseFloat(a.stat));
            return groups;
        }

        function renderGroupedLeaderBoard(groups, config) {
            const container = document.getElementById('data-container');
            let html = `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">`;
            const sortedGroupKeys = Object.keys(groups).sort((a, b) => {
                let idxA = DISPLAY_ORDER_PRIORITY.indexOf(a), idxB = DISPLAY_ORDER_PRIORITY.indexOf(b);
                if (idxA === -1) idxA = 999; if (idxB === -1) idxB = 999;
                return idxA - idxB;
            });

            for (let groupName of sortedGroupKeys) {
                const players = groups[groupName];
                const top5 = players.slice(0, 5);
                html += `
                <div class="mlb-card rounded-xl overflow-hidden flex flex-col group hover:border-[#fbbf24]/50 transition duration-300">
                    <div class="bg-gradient-to-r ${config.color} p-4 text-white flex items-center justify-between border-b border-white/10">
                        <div><h3 class="font-sport text-2xl uppercase tracking-wider drop-shadow-md">${groupName}</h3><span class="text-[10px] font-bold tracking-widest opacity-80 bg-black/20 px-2 py-0.5 rounded">TOP 5 ${config.label}</span></div>
                        <i data-lucide="${config.icon}" class="w-8 h-8 text-white/20 transform group-hover:scale-125 group-hover:rotate-12 transition duration-500"></i>
                    </div>
                    <div class="p-0 flex-grow bg-[#0f172a]/40">
                        ${top5.map((p, i) => {
                            let rankStyle = i===0?'text-yellow-400':(i===1?'text-slate-300':(i===2?'text-orange-400':'text-slate-500 font-[Teko] text-xl'));
                            let icon = i<3 ? 'medal' : '';
                            return `<div class="flex items-center justify-between p-3 border-b border-white/5 hover:bg-white/5 transition"><div class="flex items-center gap-3 w-full"><div class="w-8 flex justify-center flex-shrink-0 ${rankStyle}">${i<3?`<i data-lucide="${icon}" class="w-6 h-6"></i>`:`<span class="font-bold">${i+1}</span>`}</div><div class="min-w-0 flex-grow"><p class="font-black text-white text-lg uppercase truncate font-sport tracking-wide leading-none mb-0.5">${p.name.toLowerCase()}</p><p class="text-xs text-slate-400 font-bold uppercase truncate">${p.team}</p></div><div class="text-right pl-2"><span class="font-[Teko] font-black text-2xl text-white tracking-widest">${p.stat}</span></div></div></div>`;
                        }).join('')}
                    </div>
                </div>`;
            }
            html += `</div>`;
            container.innerHTML = html;
        }

        function renderStandings(data) {
            const container = document.getElementById('data-container');
            const headers = ['POS', 'EQUIPO', 'JJ', 'JG', 'JE', 'JP', 'CF', 'CC', 'DIF'];
            let html = `
                <div class="mlb-card rounded-xl overflow-hidden shadow-2xl">
                    <div class="overflow-x-auto custom-scrollbar">
                        <table class="w-full text-base">
                            <thead class="bg-gradient-to-r from-pega-navy to-black text-white font-[Teko] text-xl border-b border-[#fbbf24]/50"><tr>${headers.map(h => `<th class="px-4 py-4 text-center tracking-wider">${h}</th>`).join('')}</tr></thead>
                            <tbody class="divide-y divide-white/5">
                                ${data.map(row => {
                                    const pos = row[0];
                                    let rowClass = 'hover:bg-white/5 transition text-center font-medium text-slate-300';
                                    let posBadge = 'bg-slate-700 text-slate-300';
                                    if(pos==1) { posBadge='gold-gradient text-black shadow-lg shadow-yellow-500/50'; rowClass += ' bg-yellow-500/5'; }
                                    if(pos==2) { posBadge='silver-gradient text-black'; }
                                    if(pos==3) { posBadge='bronze-gradient text-white'; }
                                    const get = i => row[i] || '-';
                                    
                                    // AHORA TODOS LOS N√öMEROS TIENEN CLASE text-3xl COMO 'DIF'
                                    return `<tr class="${rowClass}">
                                        <td class="px-4 py-4"><span class="inline-flex w-8 h-8 rounded-lg items-center justify-center text-sm font-black ${posBadge}">${pos}</span></td>
                                        
                                        <td class="px-4 py-4 text-left font-bold text-white font-[Teko] text-2xl md:text-3xl tracking-wide uppercase">${get(1)}</td>
                                        
                                        <!-- JJ -->
                                        <td class="px-4 py-4 text-center font-[Teko] text-3xl text-white">${get(2)}</td>
                                        
                                        <!-- JG (Verde) -->
                                        <td class="px-4 py-4 text-center font-[Teko] text-3xl font-bold text-green-400">${get(3)}</td>

                                        <!-- JE -->
                                        <td class="px-4 py-4 text-center font-[Teko] text-3xl text-slate-400">${get(4)}</td>

                                        <!-- JP (Rojo) -->
                                        <td class="px-4 py-4 text-center font-[Teko] text-3xl font-bold text-red-400">${get(5)}</td>

                                        <!-- CF (Azul) -->
                                        <td class="px-4 py-4 text-center font-[Teko] text-3xl text-blue-400">${get(6)}</td>
                                        
                                        <!-- CC (Naranja) -->
                                        <td class="px-4 py-4 text-center font-[Teko] text-3xl text-orange-400">${get(7)}</td>
                                        
                                        <!-- DIF (Blanco Resaltado) -->
                                        <td class="px-4 py-4 text-center font-[Teko] font-black text-white text-3xl tracking-widest bg-white/5 rounded-lg">${get(8)}</td>
                                    </tr>`;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>`;
            
            // Mobile Cards View (N√∫meros Grandes)
            html += `<div class="md:hidden grid gap-4">${data.map(row => `
                <div class="mlb-card p-5 rounded-xl border-l-4 ${row[0]==1?'border-[#fbbf24] bg-gradient-to-r from-yellow-500/10 to-transparent':'border-slate-600'}">
                    <div class="flex justify-between items-center mb-4">
                        <div class="flex items-center gap-3">
                            <span class="font-[Teko] text-4xl text-white/20 font-bold">#${row[0]}</span>
                            <h3 class="font-black text-white uppercase text-2xl leading-tight tracking-wide">${row[1]}</h3>
                        </div>
                        <div class="flex flex-col items-end">
                             <span class="text-[10px] text-slate-400 uppercase tracking-widest">DIF</span>
                             <span class="font-[Teko] text-3xl font-bold text-[#fbbf24] bg-white/5 px-2 rounded border border-white/10">${row[8]}</span>
                        </div>
                    </div>
                    <div class="grid grid-cols-4 gap-2 text-center bg-black/30 p-4 rounded-xl border border-white/5">
                        <div>
                            <span class="text-[9px] block text-slate-500 uppercase tracking-wider mb-1">JJ</span>
                            <b class="text-white text-3xl font-[Teko]">${row[2]}</b>
                        </div>
                        <div>
                            <span class="text-[9px] block text-green-500 uppercase tracking-wider mb-1">GAN</span>
                            <b class="text-green-400 text-3xl font-[Teko]">${row[3]}</b>
                        </div>
                        <div>
                            <span class="text-[9px] block text-red-500 uppercase tracking-wider mb-1">PER</span>
                            <b class="text-red-400 text-3xl font-[Teko]">${row[5]}</b>
                        </div>
                        <div>
                            <span class="text-[9px] block text-blue-500 uppercase tracking-wider mb-1">CF</span>
                            <b class="text-blue-400 text-3xl font-[Teko]">${row[6]}</b>
                        </div>
                    </div>
                </div>`).join('')}</div>`;
            container.innerHTML = html;
        }

        // --- AN√ÅLISIS ESTAD√çSTICO (SIN IA EXTERNA) ---

        // --- AN√ÅLISIS ESTAD√çSTICO (DIAGN√ìSTICO T√ÅCTICO) ---
        function generateStaticAnalysis() {
            const btn = document.getElementById('btn-analyze');
            const resultContainer = document.getElementById('analysis-result');
            const contentDiv = document.getElementById('analysis-content');
            
            if (!globalData || globalData.length === 0) {
                showToast("No hay datos para analizar.", "error");
                return;
            }

            const originalText = btn.innerHTML;
            btn.innerHTML = `<i data-lucide="loader-2" class="w-6 h-6 animate-spin"></i> CALCULANDO ESTRATEGIA...`;
            btn.disabled = true;

            setTimeout(() => {
                try {
                    // MODIFICACI√ìN: Usar TODOS los datos globales sin filtrar por promedio
                    let activeTeams = globalData; 
                    
                    if (activeTeams.length === 0) {
                         const analysisHTML = `<div class="p-4 text-center text-slate-300">La temporada a√∫n no comienza o no hay datos de juegos registrados.</div>`;
                         contentDiv.innerHTML = analysisHTML;
                         resultContainer.classList.remove('hidden');
                         btn.disabled = false;
                         btn.innerHTML = originalText;
                         return;
                    }

                    let reportsHTML = `<div class="grid grid-cols-1 md:grid-cols-2 gap-4">`;

                    activeTeams.forEach(team => {
                        const pos = team[0];
                        const name = team[1];
                        const jg = parseInt(team[3]) || 0;
                        const jp = parseInt(team[5]) || 0;
                        const cf = parseInt(team[6]) || 0;
                        const cc = parseInt(team[7]) || 0;
                        const dif = parseInt(team[8]) || 0;
                        const jj = parseInt(team[2]) || 0;
                        
                        const pct = jj > 0 ? jg / jj : 0;
                        const avgRunsFor = jj > 0 ? (cf / jj).toFixed(1) : 0;
                        const avgRunsAgainst = jj > 0 ? (cc / jj).toFixed(1) : 0;
                        
                        let statusColor = "border-slate-600";
                        let badgeClass = "bg-slate-600 text-slate-200";
                        let statusText = "En Desarrollo";
                        
                        // L√≥gica de Diagn√≥stico (Qu√© mejorar)
                        let diagnosis = "";
                        let tacticalAdvice = "";

                        if (jj === 0) {
                            statusColor = "border-slate-500";
                            statusText = "Por Debutar";
                            diagnosis = "Sin datos de juego.";
                            tacticalAdvice = "El equipo est√° listo para iniciar la temporada. La clave ser√° establecer una rotaci√≥n de pitcheo s√≥lida desde el d√≠a 1.";
                        } else if (pct >= 0.8) {
                            statusColor = "border-yellow-500";
                            badgeClass = "bg-yellow-500 text-black";
                            statusText = "Potencia de Liga";
                            diagnosis = `Promedian ${avgRunsFor} carreras por juego.`;
                            tacticalAdvice = "Est√°n jugando b√©isbol casi perfecto. El √∫nico riesgo es el exceso de confianza. Mantener la intensidad en el corrido de bases asegurar√° el campeonato.";
                        } else if (cf > cc && jp > jg) {
                            // Anotan m√°s de lo que reciben pero pierden (Mala suerte o juegos cerrados perdidos)
                            statusColor = "border-orange-500";
                            badgeClass = "bg-orange-600 text-white";
                            statusText = "Bates Calientes / Defensa Fr√≠a";
                            diagnosis = `Anotan mucho (${avgRunsFor} pp) pero permiten ${avgRunsAgainst}.`;
                            tacticalAdvice = "Su ofensiva es de campeonato, pero la defensa est√° regalando juegos. <strong class='text-white'>Necesitan reforzar el cuadro interior y reducir errores</strong> para capitalizar su poder al bate.";
                        } else if (cc < cf && jg > jp) {
                            // Ganan s√≥lido
                            statusColor = "border-green-500";
                            badgeClass = "bg-green-600 text-white";
                            statusText = "Contendiente S√≥lido";
                            diagnosis = `Balance positivo (+${dif} carreras).`;
                            tacticalAdvice = "Equipo muy equilibrado. Para asegurar el liderato, deben enfocarse en ganar los duelos directos contra los rivales del Top 3.";
                        } else if (Math.abs(dif) <= 5 && jp >= jg) {
                            // Juegos cerrados
                            statusColor = "border-blue-500";
                            badgeClass = "bg-blue-600 text-white";
                            statusText = "Competitivo";
                            diagnosis = "Juegos definidos por la m√≠nima.";
                            tacticalAdvice = "Est√°n perdiendo juegos apretados. <strong class='text-white'>Les falta el 'batazo oportuno'</strong> con gente en base. Trabajar en situaciones de presi√≥n cambiar√° esos resultados.";
                        } else if (cf < (cc * 0.6)) {
                            // Problema ofensivo grave
                            statusColor = "border-red-500";
                            badgeClass = "bg-red-600 text-white";
                            statusText = "Alerta Ofensiva";
                            diagnosis = `Solo ${avgRunsFor} carreras por juego.`;
                            tacticalAdvice = "El pitcheo no puede hacerlo todo solo. <strong class='text-white'>Urge despertar los bates</strong>; necesitan ser m√°s agresivos al primer lanzamiento y embasarse para generar presi√≥n.";
                        } else {
                            statusColor = "border-slate-500";
                            statusText = "En Reconstrucci√≥n";
                            diagnosis = `Diferencial de ${dif}.`;
                            tacticalAdvice = "Temporada de aprendizaje. Enfocarse en los fundamentos defensivos para evitar innings grandes del rival y construir confianza inning a inning.";
                        }

                        const leaders = teamLeadersInfo[name.toUpperCase().trim()];
                        let leaderHTML = "";
                        if (leaders && leaders.length > 0) {
                            leaderHTML = `<div class="mt-3 pt-2 border-t border-white/10"><p class="text-[10px] text-[#fbbf24] font-bold uppercase flex items-center gap-1 mb-1"><i data-lucide="star" class="w-3 h-3"></i> Jugador Clave</p><ul class="text-xs text-white list-disc list-inside">${leaders.map(l => `<li>${l}</li>`).join('')}</ul></div>`;
                        }

                        reportsHTML += `
                            <div class="bg-slate-800/50 border-l-4 ${statusColor} p-4 rounded-r-xl hover:bg-slate-800 transition shadow-lg flex flex-col h-full animate-fadeIn">
                                <div class="flex justify-between items-start mb-2">
                                    <div class="flex items-center gap-3">
                                        <span class="font-[Teko] text-2xl text-slate-500 w-6 text-center">#${pos}</span>
                                        <div>
                                            <h4 class="text-white font-black text-lg leading-tight uppercase tracking-wide truncate w-32 md:w-48" title="${name}">${name}</h4>
                                            <span class="text-[9px] uppercase tracking-wider font-bold px-2 py-0.5 rounded-full inline-block mt-1 ${badgeClass}">${statusText}</span>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <span class="block text-2xl font-[Teko] font-bold text-white">${jg}-${jp}</span>
                                    </div>
                                </div>
                                
                                <div class="mb-2">
                                    <p class="text-xs text-slate-400 font-bold uppercase mb-1">Diagn√≥stico:</p>
                                    <p class="text-sm text-slate-200">${diagnosis}</p>
                                </div>
                                <div class="mb-2 flex-grow">
                                    <p class="text-xs text-[#fbbf24] font-bold uppercase mb-1">√Årea de Mejora:</p>
                                    <p class="text-sm text-slate-300 leading-snug">${tacticalAdvice}</p>
                                </div>

                                ${leaderHTML}
                            </div>
                        `;
                    });

                    reportsHTML += `</div>`;
                    contentDiv.innerHTML = reportsHTML;
                    resultContainer.classList.remove('hidden');
                    resultContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    lucide.createIcons();
                } catch (e) {
                    console.error("Error an√°lisis:", e);
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            }, 600);
        }

        function openUploadModal() {
            const modal = document.getElementById('uploadModal');
            if(loadedTeams.length > 0) { document.getElementById('teamSelect').innerHTML = '<option value="">Selecciona...</option>' + loadedTeams.map(t => `<option value="${t}">${t}</option>`).join(''); }
            modal.showModal();
        }
    </script>
</body>
</html>
